<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes核心技术Pod | Tang&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/TB5.PNG">
    <meta name="description" content="This is a blog.">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b7977b83.css" as="style"><link rel="preload" href="/blog/assets/js/app.e73b4e1b.js" as="script"><link rel="preload" href="/blog/assets/js/2.b9ee97ed.js" as="script"><link rel="preload" href="/blog/assets/js/3.1a9a9aa8.js" as="script"><link rel="preload" href="/blog/assets/js/35.b92037a4.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.46a9b7cb.js"><link rel="prefetch" href="/blog/assets/js/11.edd860bb.js"><link rel="prefetch" href="/blog/assets/js/12.67d6063c.js"><link rel="prefetch" href="/blog/assets/js/13.8e4df3e4.js"><link rel="prefetch" href="/blog/assets/js/14.2964adbd.js"><link rel="prefetch" href="/blog/assets/js/15.df5207a6.js"><link rel="prefetch" href="/blog/assets/js/16.a4b38cb7.js"><link rel="prefetch" href="/blog/assets/js/17.b407d545.js"><link rel="prefetch" href="/blog/assets/js/18.9b08a2c5.js"><link rel="prefetch" href="/blog/assets/js/19.a0d16106.js"><link rel="prefetch" href="/blog/assets/js/20.1154df00.js"><link rel="prefetch" href="/blog/assets/js/21.eb11eb1e.js"><link rel="prefetch" href="/blog/assets/js/22.76a29028.js"><link rel="prefetch" href="/blog/assets/js/23.0acd858b.js"><link rel="prefetch" href="/blog/assets/js/24.6d981da0.js"><link rel="prefetch" href="/blog/assets/js/25.7273bd34.js"><link rel="prefetch" href="/blog/assets/js/26.e6de3326.js"><link rel="prefetch" href="/blog/assets/js/27.125a0cf7.js"><link rel="prefetch" href="/blog/assets/js/28.f2a9565f.js"><link rel="prefetch" href="/blog/assets/js/29.f2e2a15e.js"><link rel="prefetch" href="/blog/assets/js/30.c7140aa3.js"><link rel="prefetch" href="/blog/assets/js/31.be14f48a.js"><link rel="prefetch" href="/blog/assets/js/32.cad12114.js"><link rel="prefetch" href="/blog/assets/js/33.c52cf6b7.js"><link rel="prefetch" href="/blog/assets/js/34.c280b699.js"><link rel="prefetch" href="/blog/assets/js/36.5d375ef8.js"><link rel="prefetch" href="/blog/assets/js/37.9864dcad.js"><link rel="prefetch" href="/blog/assets/js/38.76f58e95.js"><link rel="prefetch" href="/blog/assets/js/39.6c2cfb3d.js"><link rel="prefetch" href="/blog/assets/js/4.0efe21ed.js"><link rel="prefetch" href="/blog/assets/js/40.bce1f387.js"><link rel="prefetch" href="/blog/assets/js/41.4061fc33.js"><link rel="prefetch" href="/blog/assets/js/42.e1420cb9.js"><link rel="prefetch" href="/blog/assets/js/43.303be1a3.js"><link rel="prefetch" href="/blog/assets/js/44.f108ece5.js"><link rel="prefetch" href="/blog/assets/js/45.ae5cc1d3.js"><link rel="prefetch" href="/blog/assets/js/46.d093f422.js"><link rel="prefetch" href="/blog/assets/js/47.0942289d.js"><link rel="prefetch" href="/blog/assets/js/48.440ab7dd.js"><link rel="prefetch" href="/blog/assets/js/49.53fffc4f.js"><link rel="prefetch" href="/blog/assets/js/5.b6ee9800.js"><link rel="prefetch" href="/blog/assets/js/50.6107b786.js"><link rel="prefetch" href="/blog/assets/js/51.51d8f7f9.js"><link rel="prefetch" href="/blog/assets/js/52.85a869ac.js"><link rel="prefetch" href="/blog/assets/js/53.2e6d901e.js"><link rel="prefetch" href="/blog/assets/js/54.39732fad.js"><link rel="prefetch" href="/blog/assets/js/55.d9c58b2c.js"><link rel="prefetch" href="/blog/assets/js/56.759bbaf3.js"><link rel="prefetch" href="/blog/assets/js/57.0375832e.js"><link rel="prefetch" href="/blog/assets/js/58.a1b92006.js"><link rel="prefetch" href="/blog/assets/js/59.9f076a3f.js"><link rel="prefetch" href="/blog/assets/js/6.6c5f0eff.js"><link rel="prefetch" href="/blog/assets/js/60.e5ebe0a9.js"><link rel="prefetch" href="/blog/assets/js/61.fa526579.js"><link rel="prefetch" href="/blog/assets/js/62.ea0a29ee.js"><link rel="prefetch" href="/blog/assets/js/63.2436f8b6.js"><link rel="prefetch" href="/blog/assets/js/64.8a2e7054.js"><link rel="prefetch" href="/blog/assets/js/65.24dfb0df.js"><link rel="prefetch" href="/blog/assets/js/66.e8b872fd.js"><link rel="prefetch" href="/blog/assets/js/67.bde0e404.js"><link rel="prefetch" href="/blog/assets/js/7.eeb9048d.js"><link rel="prefetch" href="/blog/assets/js/8.afef3c3b.js"><link rel="prefetch" href="/blog/assets/js/9.706c6c8a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b7977b83.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/TB5.PNG" alt="Tang's Blog" class="logo"> <span class="site-name can-hide">Tang's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术笔记" class="dropdown-title"><span class="title">技术笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术笔记" class="mobile-dropdown-title"><span class="title">技术笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/db/" class="nav-link">
  DB
</a></li><li class="dropdown-item"><!----> <a href="/blog/microservice/" class="nav-link">
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/blog/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/blog/bigdata/" class="nav-link">
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/blog/devops/" class="nav-link router-link-active">
  DevOps
</a></li><li class="dropdown-item"><!----> <a href="/blog/newlanguage/" class="nav-link">
  新语言
</a></li><li class="dropdown-item"><!----> <a href="/blog/othertool/" class="nav-link">
  其他工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/readbook/" class="nav-link">
  读书分享
</a></li><li class="dropdown-item"><!----> <a href="/blog/guitar/" class="nav-link">
  吉他谱
</a></li><li class="dropdown-item"><!----> <a href="/blog/food/" class="nav-link">
  饮食
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术笔记" class="dropdown-title"><span class="title">技术笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术笔记" class="mobile-dropdown-title"><span class="title">技术笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/db/" class="nav-link">
  DB
</a></li><li class="dropdown-item"><!----> <a href="/blog/microservice/" class="nav-link">
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/blog/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/blog/bigdata/" class="nav-link">
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/blog/devops/" class="nav-link router-link-active">
  DevOps
</a></li><li class="dropdown-item"><!----> <a href="/blog/newlanguage/" class="nav-link">
  新语言
</a></li><li class="dropdown-item"><!----> <a href="/blog/othertool/" class="nav-link">
  其他工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/readbook/" class="nav-link">
  读书分享
</a></li><li class="dropdown-item"><!----> <a href="/blog/guitar/" class="nav-link">
  吉他谱
</a></li><li class="dropdown-item"><!----> <a href="/blog/food/" class="nav-link">
  饮食
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>代码仓库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CI(持续集成)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>容器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Kubenetes</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/container/k8s/k8s-1.html" class="sidebar-link">Kubenetes简介</a></li><li><a href="/blog/devops/container/k8s/k8s-2.html" class="sidebar-link">搭建Kubenetes</a></li><li><a href="/blog/devops/container/k8s/k8s-3.html" class="sidebar-link">Kubernetes集群管理工具kubectl</a></li><li><a href="/blog/devops/container/k8s/k8s-4.html" class="sidebar-link">Kubernetes集群YAML文件详解</a></li><li><a href="/blog/devops/container/k8s/k8s-5.html" aria-current="page" class="active sidebar-link">Kubernetes核心技术Pod</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#pod概述" class="sidebar-link">Pod概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#pod基本概念" class="sidebar-link">Pod基本概念</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#pod存在的意义" class="sidebar-link">Pod存在的意义</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#pod实现机制" class="sidebar-link">Pod实现机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#共享网络" class="sidebar-link">共享网络</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#共享存储" class="sidebar-link">共享存储</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#pod镜像拉取策略" class="sidebar-link">Pod镜像拉取策略</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#pod资源限制" class="sidebar-link">Pod资源限制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#示例" class="sidebar-link">示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#pod重启机制" class="sidebar-link">Pod重启机制</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#pod健康检查" class="sidebar-link">Pod健康检查</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#pod调度策略" class="sidebar-link">Pod调度策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#创建pod流程" class="sidebar-link">创建Pod流程</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#影响pod调度的属性" class="sidebar-link">影响Pod调度的属性</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#污点和污点容忍" class="sidebar-link">污点和污点容忍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#场景" class="sidebar-link">场景</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#查看污点情况" class="sidebar-link">查看污点情况</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#未节点添加污点" class="sidebar-link">未节点添加污点</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#删除污点" class="sidebar-link">删除污点</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#演示" class="sidebar-link">演示</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-5.html#污点容忍" class="sidebar-link">污点容忍</a></li></ul></li></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>监控</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kubernetes核心技术pod"><a href="#kubernetes核心技术pod" class="header-anchor">#</a> Kubernetes核心技术Pod</h1> <h2 id="pod概述"><a href="#pod概述" class="header-anchor">#</a> Pod概述</h2> <p>Pod是K8S系统中可以创建和管理的最小单元，是资源对象模型中由用户创建或部署的最小资源对象模型，也是在K8S上运行容器化应用的资源对象，其它的资源对象都是用来支撑或者扩展Pod对象功能的，比如控制器对象是用来管控Pod对象的，Service或者Ingress资源对象是用来暴露Pod引用对象的，PersistentVolume资源对象是用来为Pod提供存储等等，K8S不会直接处理容器，而是Pod，Pod是由一个或多个container组成。</p> <p>Pod是Kubernetes的最重要概念，每一个Pod都有一个特殊的被称为 “根容器”的Pause容器。Pause容器对应的镜像属于Kubernetes平台的一部分，除了Pause容器，每个Pod还包含一个或多个紧密相关的用户业务容器。</p> <p><img src="images/image-20201114185528215.png" alt="image-20201114185528215"></p> <h3 id="pod基本概念"><a href="#pod基本概念" class="header-anchor">#</a> Pod基本概念</h3> <ul><li>最小部署的单元</li> <li>Pod里面是由一个或多个容器组成【一组容器的集合】</li> <li>一个pod中的容器是共享网络命名空间</li> <li>Pod是短暂的</li> <li>每个Pod包含一个或多个紧密相关的用户业务容器</li></ul> <h3 id="pod存在的意义"><a href="#pod存在的意义" class="header-anchor">#</a> Pod存在的意义</h3> <ul><li>创建容器使用docker，一个docker对应一个容器，一个容器运行一个应用进程</li> <li>Pod是多进程设计，运用多个应用程序，也就是一个Pod里面有多个容器，而一个容器里面运行一个应用程序</li></ul> <p><img src="images/image-20201114190018948.png" alt="image-20201114190018948"></p> <ul><li>Pod的存在是为了亲密性应用
<ul><li>两个应用之间进行交互</li> <li>网络之间的调用【通过127.0.0.1 或 socket】</li> <li>两个应用之间需要频繁调用</li></ul></li></ul> <p>Pod是在K8S集群中运行部署应用或服务的最小单元，它是可以支持多容器的。Pod的设计理念是支持多个容器在一个Pod中共享网络地址和文件系统，可以通过进程间通信和文件共享这种简单高效的方式组合完成服务。同时Pod对多容器的支持是K8S中最基础的设计理念。在生产环境中，通常是由不同的团队各自开发构建自己的容器镜像，在部署的时候组合成一个微服务对外提供服务。</p> <p>Pod是K8S集群中所有业务类型的基础，可以把Pod看作运行在K8S集群上的小机器人，不同类型的业务就需要不同类型的小机器人去执行。目前K8S的业务主要可以分为以下几种</p> <ul><li>长期伺服型：long-running</li> <li>批处理型：batch</li> <li>节点后台支撑型：node-daemon</li> <li>有状态应用型：stateful application</li></ul> <p>上述的几种类型，分别对应的小机器人控制器为：Deployment、Job、DaemonSet 和 StatefulSet  (后面将介绍控制器)</p> <h2 id="pod实现机制"><a href="#pod实现机制" class="header-anchor">#</a> Pod实现机制</h2> <p>主要有以下两大机制</p> <ul><li>共享网络</li> <li>共享存储</li></ul> <h3 id="共享网络"><a href="#共享网络" class="header-anchor">#</a> 共享网络</h3> <p>容器本身之间相互隔离的，一般是通过 <strong>namespace</strong> 和 <strong>group</strong> 进行隔离，那么Pod里面的容器如何实现通信？</p> <ul><li>首先需要满足前提条件，也就是容器都在同一个<strong>namespace</strong>之间</li></ul> <p>关于Pod实现原理，首先会在Pod会创建一个根容器： <code>pause容器</code>，然后我们在创建业务容器 【nginx，redis 等】，在我们创建业务容器的时候，会把它添加到 <code>info容器</code> 中</p> <p>而在 <code>info容器</code> 中会独立出  ip地址，mac地址，port 等信息，然后实现网络的共享</p> <p><img src="images/image-20201114190913859.png" alt="image-20201114190913859"></p> <p>完整步骤如下</p> <ul><li>通过 Pause 容器，把其它业务容器加入到Pause容器里，让所有业务容器在同一个名称空间中，可以实现网络共享</li></ul> <h3 id="共享存储"><a href="#共享存储" class="header-anchor">#</a> 共享存储</h3> <p>Pod持久化数据，专门存储到某个地方中</p> <p><img src="images/image-20201114193124160.png" alt="image-20201114193124160"></p> <p>使用 Volumn数据卷进行共享存储，案例如下所示</p> <p><img src="images/image-20201114193341993.png" alt="image-20201114193341993"></p> <h2 id="pod镜像拉取策略"><a href="#pod镜像拉取策略" class="header-anchor">#</a> Pod镜像拉取策略</h2> <p>我们以具体实例来说，拉取策略就是 <code>imagePullPolicy</code></p> <p><img src="images/image-20201114193605230.png" alt="image-20201114193605230"></p> <p>拉取策略主要分为了以下几种</p> <ul><li>IfNotPresent：默认值，镜像在宿主机上不存在才拉取</li> <li>Always：每次创建Pod都会重新拉取一次镜像</li> <li>Never：Pod永远不会主动拉取这个镜像</li></ul> <h2 id="pod资源限制"><a href="#pod资源限制" class="header-anchor">#</a> Pod资源限制</h2> <p>也就是我们Pod在进行调度的时候，可以对调度的资源进行限制，例如我们限制 Pod调度是使用的资源是 2C4G，那么在调度对应的node节点时，只会占用对应的资源，对于不满足资源的节点，将不会进行调度</p> <p><img src="images/image-20201114194057920.png" alt="image-20201114194057920"></p> <h3 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h3> <p>我们在下面的地方进行资源的限制</p> <p><img src="images/image-20201114194245517.png" alt="image-20201114194245517"></p> <p>这里分了两个部分</p> <ul><li>request：表示调度所需的资源</li> <li>limits：表示最大所占用的资源</li></ul> <h2 id="pod重启机制"><a href="#pod重启机制" class="header-anchor">#</a> Pod重启机制</h2> <p>因为Pod中包含了很多个容器，假设某个容器出现问题了，那么就会触发Pod重启机制</p> <p><img src="images/image-20201114194722125.png" alt="image-20201114194722125"></p> <p>重启策略主要分为以下三种</p> <ul><li>Always：当容器终止退出后，总是重启容器，默认策略 【nginx等，需要不断提供服务】</li> <li>OnFailure：当容器异常退出（退出状态码非0）时，才重启容器。</li> <li>Never：当容器终止退出，从不重启容器 【批量任务】</li></ul> <h2 id="pod健康检查"><a href="#pod健康检查" class="header-anchor">#</a> Pod健康检查</h2> <p>通过容器检查，原来我们使用下面的命令来检查</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get pod
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但是有的时候，程序可能出现了 <strong>Java</strong> 堆内存溢出，程序还在运行，但是不能对外提供服务了，这个时候就不能通过 容器检查来判断服务是否可用了</p> <p>这个时候就可以使用应用层面的检查</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 存活检查，如果检查失败，将杀死容器，根据Pod的restartPolicy【重启策略】来操作</span>
livenessProbe

<span class="token comment"># 就绪检查，如果检查失败，Kubernetes会把Pod从Service endpoints中剔除</span>
readinessProbe
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="images/image-20201114195807564.png" alt="image-20201114195807564"></p> <p>Probe支持以下三种检查方式</p> <ul><li>http Get：发送HTTP请求，返回200 - 400 范围状态码为成功</li> <li>exec：执行Shell命令返回状态码是0为成功</li> <li>tcpSocket：发起TCP Socket建立成功</li></ul> <h2 id="pod调度策略"><a href="#pod调度策略" class="header-anchor">#</a> Pod调度策略</h2> <h3 id="创建pod流程"><a href="#创建pod流程" class="header-anchor">#</a> 创建Pod流程</h3> <ul><li>首先创建一个pod，然后创建一个API Server 和 Etcd【把创建出来的信息存储在etcd中】</li> <li>然后创建 Scheduler，监控API Server是否有新的Pod，如果有的话，会通过调度算法，把pod调度某个node上</li> <li>在node节点，会通过 <code>kubelet -- apiserver</code> 读取etcd 拿到分配在当前node节点上的pod，然后通过docker创建容器</li></ul> <p><img src="images/image-20201114201611308.png" alt="image-20201114201611308"></p> <h3 id="影响pod调度的属性"><a href="#影响pod调度的属性" class="header-anchor">#</a> 影响Pod调度的属性</h3> <p>Pod资源限制对Pod的调度会有影响</p> <h4 id="根据request找到足够node节点进行调度"><a href="#根据request找到足够node节点进行调度" class="header-anchor">#</a> 根据request找到足够node节点进行调度</h4> <p><img src="images/image-20201114194245517.png" alt="image-20201114194245517"></p> <h4 id="节点选择器标签影响pod调度"><a href="#节点选择器标签影响pod调度" class="header-anchor">#</a> 节点选择器标签影响Pod调度</h4> <p><img src="images/image-20201114202456151.png" alt="image-20201114202456151"></p> <p>关于节点选择器，其实就是有两个环境，然后环境之间所用的资源配置不同</p> <p><img src="images/image-20201114202643905.png" alt="image-20201114202643905"></p> <p>我们可以通过以下命令，给我们的节点新增标签，然后节点选择器就会进行调度了</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl label node node1 <span class="token assign-left variable">env_role</span><span class="token operator">=</span>prod
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="节点亲和性"><a href="#节点亲和性" class="header-anchor">#</a> 节点亲和性</h4> <p>节点亲和性 <strong>nodeAffinity</strong> 和 之前nodeSelector 基本一样的，根据节点上标签约束来决定Pod调度到哪些节点上</p> <ul><li>硬亲和性：约束条件必须满足</li> <li>软亲和性：尝试满足，不保证</li></ul> <p><img src="images/image-20201114203433939.png" alt="image-20201114203433939"></p> <p>支持常用操作符：in、NotIn、Exists、Gt、Lt、DoesNotExists</p> <p>反亲和性：就是和亲和性刚刚相反，如 NotIn、DoesNotExists等</p> <h2 id="污点和污点容忍"><a href="#污点和污点容忍" class="header-anchor">#</a> 污点和污点容忍</h2> <h3 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h3> <p>nodeSelector 和 NodeAffinity，都是Prod调度到某些节点上，属于Pod的属性，是在调度的时候实现的。</p> <p>Taint 污点：节点不做普通分配调度，是节点属性</p> <h3 id="场景"><a href="#场景" class="header-anchor">#</a> 场景</h3> <ul><li>专用节点【限制ip】</li> <li>配置特定硬件的节点【固态硬盘】</li> <li>基于Taint驱逐【在node1不放，在node2放】</li></ul> <h3 id="查看污点情况"><a href="#查看污点情况" class="header-anchor">#</a> 查看污点情况</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl describe node k8smaster <span class="token operator">|</span> <span class="token function">grep</span> Taint
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="images/image-20201114204124819.png" alt="image-20201114204124819"></p> <p>污点值有三个</p> <ul><li>NoSchedule：一定不被调度</li> <li>PreferNoSchedule：尽量不被调度【也有被调度的几率】</li> <li>NoExecute：不会调度，并且还会驱逐Node已有Pod</li></ul> <h3 id="未节点添加污点"><a href="#未节点添加污点" class="header-anchor">#</a> 未节点添加污点</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl taint node <span class="token punctuation">[</span>node<span class="token punctuation">]</span> <span class="token assign-left variable">key</span><span class="token operator">=</span>value:污点的三个值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>举例：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl taint node k8snode1 <span class="token assign-left variable">env_role</span><span class="token operator">=</span>yes:NoSchedule
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="删除污点"><a href="#删除污点" class="header-anchor">#</a> 删除污点</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl taint node k8snode1 env_role:NoSchedule-
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="images/image-20201114210022883.png" alt="image-20201114210022883"></p> <h3 id="演示"><a href="#演示" class="header-anchor">#</a> 演示</h3> <p>我们现在创建多个Pod，查看最后分配到Node上的情况</p> <p>首先我们创建一个 nginx 的pod</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl create deployment web --image<span class="token operator">=</span>nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后使用命令查看</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get pods -o wide
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="images/image-20201114204917548.png" alt="image-20201114204917548"></p> <p>我们可以非常明显的看到，这个Pod已经被分配到 k8snode1 节点上了</p> <p>下面我们把pod复制5份，在查看情况pod情况</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl scale deployment web --replicas<span class="token operator">=</span><span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们可以发现，因为master节点存在污点的情况，所以节点都被分配到了 node1 和 node2节点上</p> <p><img src="images/image-20201114205135282.png" alt="image-20201114205135282"></p> <p>我们可以使用下面命令，把刚刚我们创建的pod都删除</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl delete deployment web
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在给了更好的演示污点的用法，我们现在给 node1节点打上污点</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl taint node k8snode1 <span class="token assign-left variable">env_role</span><span class="token operator">=</span>yes:NoSchedule
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后我们查看污点是否成功添加</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl describe node k8snode1 <span class="token operator">|</span> <span class="token function">grep</span> Taint
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="images/image-20201114205516154.png" alt="image-20201114205516154"></p> <p>然后我们在创建一个 pod</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 创建nginx pod</span>
kubectl create deployment web --image<span class="token operator">=</span>nginx
<span class="token comment"># 复制五次</span>
kubectl scale deployment web --replicas<span class="token operator">=</span><span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后我们在进行查看</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get pods -o wide
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们能够看到现在所有的pod都被分配到了 k8snode2上，因为刚刚我们给node1节点设置了污点</p> <p><img src="images/image-20201114205654867.png" alt="image-20201114205654867"></p> <p>最后我们可以删除刚刚添加的污点</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl taint node k8snode1 env_role:NoSchedule-
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="污点容忍"><a href="#污点容忍" class="header-anchor">#</a> 污点容忍</h3> <p>污点容忍就是某个节点可能被调度，也可能不被调度</p> <p><img src="images/image-20201114210146123.png" alt="image-20201114210146123"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/container/k8s/k8s-4.html" class="prev">
        Kubernetes集群YAML文件详解
      </a></span> <span class="next"><a href="/blog/devops/log/elk.html">
        ELK
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.e73b4e1b.js" defer></script><script src="/blog/assets/js/2.b9ee97ed.js" defer></script><script src="/blog/assets/js/3.1a9a9aa8.js" defer></script><script src="/blog/assets/js/35.b92037a4.js" defer></script>
  </body>
</html>
